#!/usr/bin/env python3
"""CUPS backend for ElasticPrinter.

This script is called by CUPS when a print job is submitted to the ElasticPrinter.
It must be installed in the CUPS backend directory (usually /usr/libexec/cups/backend/).
"""

import sys
import os

# Prevent Python from writing bytecode files
os.environ['PYTHONDONTWRITEBYTECODE'] = '1'

# Suppress xcode-select warnings
os.environ['PYTHONWARNINGS'] = 'ignore'

# Add the project directory to the path
PROJECT_DIR = "/Users/hansheerooms/Projects/elasticprinter"
if os.path.exists(PROJECT_DIR):
    sys.path.insert(0, PROJECT_DIR)

if __name__ == "__main__":
    # When called with no arguments, CUPS expects a list of available devices
    if len(sys.argv) == 1:
        # Output format: device-class device-uri "device-make-and-model" "device-info" "device-id"
        print('file elasticprinter:/ "ElasticPrinter" "Virtual PDF to Elasticsearch Printer" "MFG:ElasticPrinter;MDL:Virtual Printer;DES:ElasticPrinter Virtual Printer;"')
        sys.exit(0)
    else:
        # Process the print job - import here after path is set
        try:
            # Import from installed package
            from elasticprinter_backend import main
            main()
        except SystemExit as e:
            # Propagate sys.exit() calls
            sys.exit(e.code)
        except Exception as e:
            # Log error and exit with error code
            import traceback
            from datetime import datetime
            error_msg = f"ElasticPrinter backend error: {e}\n{traceback.format_exc()}"
            
            # Try to write to log file
            try:
                with open("/var/log/elasticprinter/backend_error.log", "a") as f:
                    f.write(f"\n{datetime.now()}: {error_msg}\n")
            except:
                pass
            
            # Write to stderr (CUPS will log this)
            sys.stderr.write(error_msg + "\n")
            sys.exit(1)
